<!--
  ~ MIT License
  ~
  ~ Copyright (c) 2018- Mosaic Networks
  ~
  ~ Permission is hereby granted, free of charge, to any person obtaining a copy
  ~ of this software and associated documentation files (the "Software"), to deal
  ~ in the Software without restriction, including without limitation the rights
  ~ to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
  ~ copies of the Software, and to permit persons to whom the Software is
  ~ furnished to do so, subject to the following conditions:
  ~
  ~ The above copyright notice and this permission notice shall be included in all
  ~ copies or substantial portions of the Software.
  ~
  ~ THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  ~ IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  ~ FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
  ~ AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  ~ LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
  ~ OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
  ~ SOFTWARE.
  -->

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Mosaic Networks" />
  <title>My First Babble App Tutorial</title>
  <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style>
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">My First Babble App Tutorial</h1>
<p class="subtitle">Version 0.1.0</p>
<p class="author">Mosaic Networks</p>
<p class="date">Version 0.1.0 – November, 2019</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#my-first-babble-app-tutorial">My First Babble App Tutorial</a><ul>
<li><a href="#babble">Babble</a><ul>
<li><a href="#design">Design</a></li>
</ul></li>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#our-first-minimal-app">Our First Minimal App</a><ul>
<li><a href="#running-the-app">Running the App</a></li>
</ul></li>
<li><a href="#our-first-babble-app">Our First Babble App</a><ul>
<li><a href="#integrating-the-babble-android-library">Integrating the Babble-Android Library</a></li>
<li><a href="#using-the-library">Using the Library</a></li>
</ul></li>
<li><a href="#our-first-babble-blockchain">Our First Babble Blockchain</a><ul>
<li><a href="#main-activity">Main Activity</a></li>
<li><a href="#appstate.java">AppState.java</a></li>
<li><a href="#babbletx.java">BabbleTx.java</a></li>
<li><a href="#message.java">Message.java</a></li>
<li><a href="#messagingservice.java">MessagingService.java</a></li>
<li><a href="#chat-activity">Chat Activity</a></li>
<li><a href="#running-babble">Running Babble</a></li>
</ul></li>
<li><a href="#some-explanations">Some Explanations</a></li>
<li><a href="#interacting-with-babble">Interacting with Babble</a><ul>
<li><a href="#activity_chat.xml">activity_chat.xml</a></li>
<li><a href="#colors.xml">colors.xml</a></li>
<li><a href="#chatactivity.java">ChatActivity.java</a></li>
<li><a href="#strings.xml">strings.xml</a></li>
<li><a href="#build-run-and-test">Build, Run and Test</a></li>
</ul></li>
<li><a href="#joining">Joining</a><ul>
<li><a href="#build-run-and-test-1">Build, Run and Test</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
<h1 id="my-first-babble-app-tutorial">My First Babble App Tutorial</h1>
<p>This article is a walkthrough of the process of building your first Android App using the <code>babble-android</code> library. We are working towards the Sample App included in the <code>babble-android</code> library<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<h2 id="babble">Babble</h2>
<p>Babble enables multiple computers to behave as one. It uses Peer to Peer (P2P) networking and a consensus algorithm to guarantee that a group of connected computers process the same commands in the same order; a technique known as state-machine replication. This makes for secure systems that can tolerate arbitrary failures, including malicious behaviour.</p>
<p>We use an adaptation of the Hashgraph consensus algorithm, invented by Leemon Baird. Hashgraph is best described in the <a href="http://www.swirlds.com/downloads/SWIRLDS-TR-2016-01.pdf">white-paper</a> and its <a href="http://www.swirlds.com/downloads/SWIRLDS-TR-2016-02.pdf">accompanying document</a>. The original algorithm is protected by <a href="http://www.swirlds.com/ip/">patents</a> in the USA. Therefore, anyone intending to use this software in the USA should obtain a license from the patent holders.</p>
<p>Hashgraph is based on the intuitive idea that gossiping about gossip itself yields enough information to compute a consensus ordering of events. It attains the theoretical limit of tolerating up to one-third of faulty nodes without compromising on speed. For those familiar with the jargon, it is a leaderless, asynchronous BFT consensus algorithm.</p>
<p>Babble projects the output of the consensus algorithm onto a linear blockchain which is more suitable for representing an ordered list of transactions and facilitates the creation of light-clients. For information about this projection please refer to <a href="http://docs.babble.io/en/latest/blockchain.html">documentation</a> pages.</p>
<p>This blockchain mapping is also instrumental in two important features that were alluded to in Baird’s paper, but not implemented:</p>
<ul>
<li><p>A <a href="http://docs.babble.io/en/latest/fastsync.html">fast-sync</a> protocol which enables nodes to join a cluster without having to download the entire history of gossip.</p></li>
<li><p>A <a href="http://docs.babble.io/en/latest/dynamic_membership.html">dynamic membership</a> protocol, which enables peers to join or leave a cluster on demand.</p></li>
</ul>
<h3 id="design">Design</h3>
<p>Babble is designed to integrate with applications written in any programming language.</p>
<h4 id="overview">Overview</h4>
<p><img src="./screenshots/babble_design_2.png" title="Babble Design" /></p>
<p>Almost any software application can be modelled in terms of a <em>service</em> and a <em>state</em>. The <em>service</em> is responsible for processing commands (ex. user input), while the <em>state</em> is responsible for manipulating and storing the data (eg. database). Usually, when commands need to update the data, the <em>service</em> will invoke the <em>state</em> directly. In a distributed application, however, commands (referred to as <em>transactions</em> in this context), must be broadcast to all replicas and consistently ordered before being applied to the <em>state</em>. This ensures that all replicas process the same commands in the same order. Hence, the <em>service</em> no longer communicates directly with the <em>state</em> (except for read-only requests), but forwards commands to a <em>transaction ordering system</em> which takes care of broadcasting and ordering the transactions across all replicas before feeding them back to the application’s <em>state</em>.</p>
<p>Babble is an ordering system that plugs into any application thanks to a very simple interface. It uses a consensus algorithm, to replicate and order the transactions, and a blockchain to represent the resulting list. A blockchain is a linear data structure composed of batches of transactions, hashed and signed together, easily allowing to verify any transaction. So, instead of applying commands directly to the <em>state</em>, Babble applications must forward the commands to Babble and let them be processed asynchronously by the consensus system before receiving them back, in blocks, ready to be applied to the <em>state</em>.</p>
<p>Note that it is left to the application layer to filter out bad transactions before relaying them from clients to the consensus engine. Unlike other middleware designed to sit in front of the application (like Apache or Tendermint), the user-facing API is app-specific, and Babble just takes care or managing the consensus “under the hood”. This filtering partially addresses spam from anonymous clients, but doesn’t protect against malicious nodes spamming the network; that is a potential enhancement on the roadmap.</p>
<h4 id="api">API</h4>
<p>Babble communicates with the App through an <code>AppProxy</code> interface, which has two implementations:</p>
<ul>
<li><p><code>SocketProxy</code>: A SocketProxy connects to an App via TCP sockets. It enables the application to run in a separate process or machine, and to be written in any programming language.</p></li>
<li><p><code>InmemProxy</code> : An InmemProxy uses native callback handlers to integrate Babble as a regular Go dependency.</p></li>
</ul>
<p>The <code>AppProxy</code> interface exposes three methods for Babble to call the App:</p>
<ul>
<li><code>CommitBlock(Block) (CommitResponse, error)</code>: Commits a block to the application and returns the resulting state-hash, with accepted internal transactions.</li>
<li><code>GetSnapshot(int) ([]byte, error)</code>: Gets the application snapshot corresponding to a particular block index.</li>
<li><code>Restore([]byte) error</code>: Restores the App state from a snapshot.</li>
</ul>
<p>Reciprocally, <code>AppProxy</code> relays transactions from the App to Babble via a native Go channel - <code>SubmitCh</code> - which ties into the application differently depending on the type of proxy (Socket or Inmem).</p>
<p>Babble asynchronously processes transactions and eventually feeds them back to the App, in consensus order and bundled into blocks, with a <strong>CommitBlock</strong> call. Transactions are just raw bytes and Babble does not need to know what they represent. Therefore, encoding and decoding transactions is done by the App.</p>
<div style="page-break-after: always; visibility: hidden">

</div>
<h2 id="prerequisites">Prerequisites</h2>
<p>We will assume that you have installed Android Studio, an Android SDK with API version 29 and Android NDK. Android API 29 (10.0 / Q) is assumed, if use a previous version the create activity items in these instructions will use AppCompat instead of AndroidX<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>, leading to incompatibilities with the pasted source code. The babble node itself is compatible with AppCompat, but converting the sample to use AppCompat is beyond the scope of this article.</p>
<p>This tutorial is going to assume deployment to a physical Android device. Thus you will need an Android device (minimum API version 19<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>) with the developer options turned on, debugging enabled, and a suitable USB cable. You could use the android emulator, but that is beyond the scope of this article.</p>
<div style="page-break-after: always; visibility: hidden">

</div>
<h2 id="our-first-minimal-app">Our First Minimal App</h2>
<p>First up we will create a minimal app to test our environment and prove that we have loaded the <code>babble-android</code> library correctly. Fire up Android Studio and select <code>File/New Project</code>. You are asked to choose a project template.</p>
<p><img src="./screenshots/create_new_project.png" title="Create New Project Screen" style="width:80.0%" /></p>
<p>Choose <em>Empty Activity</em> from the <em>Phone and Tablet</em> tab, and click Next.</p>
<p><img src="./screenshots/new_project_options.png" title="New Project Options" style="width:60.0%" /></p>
<p>The options here should be self-explanatory. We would recommend not using spaces in the Package Name or the Save Location. Do not set the Minimum API Level below 19. Click Finish.</p>
<p><img src="./screenshots/empty_android_studio.png" title="Initial Android Studio" /></p>
<p>Android Studio will open, and after expanding some of the menus it will look something like above.</p>
<p><em>N.B. the screen will change a few seconds after opening when the initial gradle scripts complete. The status bar at the bottom of the window should tell you this is happening.</em></p>
<div style="page-break-after: always; visibility: hidden">

</div>
<h3 id="running-the-app">Running the App</h3>
<p>Connect your android device to your computer via a USB cable. First we will test that the Android Debug Bridge (<strong>adb</strong>) can see the device.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="ex">jon@hpjon</span>:~/Android/MyFirstApp$ adb devices</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="ex">List</span> of devices attached</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="ex">4JPNU18709118621</span>    device</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="ex">jon@hpjon</span>:~/Android/MyFirstApp$ </span></code></pre></div>
<p>The command <code>adb kill-server</code> will reset this connection.</p>
<p>If you can see a device listed, go back to Android Studio. and in the top right is a target device dropdown. Select your device from the list.</p>
<p><img src="./screenshots/device_selection.png" title="Select Device" /></p>
<p>If you cannot find your device in the list, the <code>Troubleshoot device connections</code> option on that menu should help.</p>
<p>Then press that little green triangle to the right of the dropdown device menu. Gradle then builds the app, which is then installed onto the physical android device that you selected. The whole process tool about 20 seconds on my laptop (feel free to buy me a quicker one).</p>
<p><img src="./screenshots/mobile_step_1.png" title="First App Screenshot" style="width:50.0%" /> <img src="./screenshots/default_icon.png" title="First App Icon" style="width:25.0%" /></p>
<p>If you look on the device, you should find the app installed, as on the right above.</p>
<p>Congratulations, you have an app. Now onto Babble…</p>
<hr />
<div style="page-break-after: always; visibility: hidden">

</div>
<h2 id="our-first-babble-app">Our First Babble App</h2>
<p>We will now integrate the <code>babble-android</code> library into our skeleton app. We will use it to generate a key pair – just to prove that we have a working library instance.</p>
<h3 id="integrating-the-babble-android-library">Integrating the Babble-Android Library</h3>
<p>The library is hosted <strong>jcenter</strong>. To make it available, we need to amend some gradle scripts.</p>
<p><img src="./screenshots/gradle_scripts.png" title="Gradle Scripts" style="width:50.0%" /></p>
<p>In Android Studio, double click on the Project <code>build.gradle</code> as highlighted in the screenshot above.</p>
<p>We then add the 3 line <code>maven</code> instruction as below:</p>
<pre class="gradle"><code>allprojects {
    repositories {
        google()
        jcenter()
        maven {
            url &#39;https://dl.bintray.com/mosaicnetworks/maven&#39;
        }
    }
} </code></pre>
<p>Which leaves the entire file looking like this:</p>
<pre class="gradle"><code>// Top-level build file where you can add configuration options common to all
// sub-projects/modules.

buildscript {
    repositories {
        google()
        jcenter()
        
    }
    dependencies {
        classpath &#39;com.android.tools.build:gradle:3.5.2&#39;
        
        // NOTE: Do not place your application dependencies here; they belong
        // in the individual module build.gradle files
    }
}

allprojects {
    repositories {
        google()
        jcenter()
        maven {
            url &#39;https://dl.bintray.com/mosaicnetworks/maven&#39;
        }
    }
}

task clean(type: Delete) {
    delete rootProject.buildDir
}
 </code></pre>
<p>Next we need to amend the app <code>build.gradle</code> (it is below the Project <code>build.gradle</code> in the screenshot above. We add an implementation line to the bottom dependencies section.</p>
<pre class="gradle"><code>implementation &#39;io.mosaicnetworks:babble:0.1.0&#39;</code></pre>
<p>This leaves us with this full file:</p>
<pre class="gradle"><code>apply plugin: &#39;com.android.application&#39;

android {
 compileSdkVersion 29
 buildToolsVersion &quot;29.0.2&quot;
 defaultConfig {
  applicationId &quot;io.mosaicnetworks.myfirstapp&quot;
  minSdkVersion 19
  targetSdkVersion 29
  versionCode 1
  versionName &quot;1.0&quot;
  testInstrumentationRunner &quot;androidx.test.runner.AndroidJUnitRunner&quot;
}
buildTypes {
 release {
 minifyEnabled false
 proguardFiles getDefaultProguardFile(&#39;proguard-android-optimize.txt&#39;),
     &#39;proguard-rules.pro&#39;
  }
 }
}

dependencies {
  implementation fileTree(dir: &#39;libs&#39;, include: [&#39;*.jar&#39;])
  implementation &#39;io.mosaicnetworks:babble:0.2.1&#39;
  implementation &#39;androidx.appcompat:appcompat:1.1.0&#39;
  implementation &#39;androidx.constraintlayout:constraintlayout:1.1.3&#39;
  testImplementation &#39;junit:junit:4.12&#39;
  androidTestImplementation &#39;androidx.test.ext:junit:1.1.1&#39;
  androidTestImplementation &#39;androidx.test.espresso:espresso-core:3.2.0&#39;
}</code></pre>
<p><img src="./screenshots/sync_message.png" title="Sync Message" /></p>
<p>When you get a message like the above, click the <code>Sync Now</code> link on the right of the message.</p>
<h3 id="using-the-library">Using the Library</h3>
<p>The library should now be included in the project. So lets use it! Open <code>MainActivity.java</code> as below:</p>
<p><img src="./screenshots/main_activity.png" title="Main Activity" /></p>
<p>Add the lines below underneath the last import statement. The lines will appear greyed out, as the import is not yet used. As well as babble we are importing the <code>Log</code> package to write to the Android logs.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">import</span><span class="im"> io.mosaicnetworks.babble.node.KeyPair;</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="kw">import</span><span class="im"> android.util.Log;</span></span></code></pre></div>
<p>Add the following lines as the last line of the <code>onCreate</code> function</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb7-1"><a href="#cb7-1"></a><span class="bu">KeyPair</span> kp = <span class="kw">new</span> <span class="bu">KeyPair</span>();</span>
<span id="cb7-2"><a href="#cb7-2"></a>Log.<span class="fu">i</span>(<span class="st">&quot;Yippee&quot;</span>,kp.<span class="fu">privateKey</span>);</span></code></pre></div>
<p>This code generates a key pair and writes the private code to the logs.</p>
<p>Save all the files and run your app.</p>
<p><img src="./screenshots/logcat.png" title="LogCat" /></p>
<p>The app looks exactly as per the previous iteration, so lets take a look under the hood. Press logcat, as highlighted in gray in the screenshot above. Then type <code>yippee</code> in the search box at the top of that window to filter the logs. You should have a freshly generated private key in there.</p>
<p>This project at this stage is available from github from <a href="https://github.com/mosaicnetworks/babble-android-tutorial/tree/stage1">here</a> <a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
<p>The downloadable version of the project has mosaic network icons, rather than the default android ones. You can customise the icons using <a href="https://developer.android.com/studio/write/image-asset-studio">Android Studio Image Asset Studio</a>.<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a></p>
<hr />
<div style="page-break-after: always; visibility: hidden">

</div>
<h2 id="our-first-babble-blockchain">Our First Babble Blockchain</h2>
<p>Now we have access to the babble library from within our app, the next stage is to start a babble network. We will start with a single node. But before we can start babble we need to add some UI elements to allow us to interact with our babble node.</p>
<p>Currently our application launches the activity <code>MainActivity</code> which calls the key pair generation code in it’s <code>onCreate</code> method.</p>
<p>In the Sample App <a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> that we are working towards, the MainActivity Screen presents the user with a choice of “<strong>New</strong>” or “<strong>Join</strong>”. <strong>New</strong> starts a new babble network with your device as the sole peer. <strong>Join</strong> lets you specify the address of an existing network, pull down the configuration for that network and request to join it.</p>
<p>As <strong>New</strong> is standalone functionality, and <strong>Join</strong> requires <strong>New</strong> be implemented to function, we will implement <strong>New</strong> first.</p>
<h3 id="main-activity">Main Activity</h3>
<p>First up we will amend <code>MainActivity.java</code>. replace all of the code with the following:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb8-1"><a href="#cb8-1"></a><span class="kw">package</span><span class="im"> io.mosaicnetworks.myfirstapp;</span></span>
<span id="cb8-2"><a href="#cb8-2"></a></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="kw">import</span><span class="im"> androidx.appcompat.app.AppCompatActivity;</span></span>
<span id="cb8-4"><a href="#cb8-4"></a></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="kw">import</span><span class="im"> android.content.Intent;</span></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="kw">import</span><span class="im"> android.os.Bundle;</span></span>
<span id="cb8-7"><a href="#cb8-7"></a></span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="kw">import</span><span class="im"> io.mosaicnetworks.babble.node.KeyPair;</span></span>
<span id="cb8-9"><a href="#cb8-9"></a></span>
<span id="cb8-10"><a href="#cb8-10"></a></span>
<span id="cb8-11"><a href="#cb8-11"></a><span class="kw">import</span><span class="im"> io.mosaicnetworks.babble.configure.BaseConfigActivity;</span></span>
<span id="cb8-12"><a href="#cb8-12"></a><span class="kw">import</span><span class="im"> io.mosaicnetworks.babble.node.BabbleService;</span></span>
<span id="cb8-13"><a href="#cb8-13"></a></span>
<span id="cb8-14"><a href="#cb8-14"></a></span>
<span id="cb8-15"><a href="#cb8-15"></a><span class="kw">import</span><span class="im"> android.util.Log;</span></span>
<span id="cb8-16"><a href="#cb8-16"></a></span>
<span id="cb8-17"><a href="#cb8-17"></a><span class="kw">public</span> <span class="kw">class</span> MainActivity <span class="kw">extends</span> BaseConfigActivity {</span>
<span id="cb8-18"><a href="#cb8-18"></a>    </span>
<span id="cb8-19"><a href="#cb8-19"></a>    <span class="at">@Override</span></span>
<span id="cb8-20"><a href="#cb8-20"></a>    <span class="kw">public</span> BabbleService <span class="fu">getBabbleService</span>() {</span>
<span id="cb8-21"><a href="#cb8-21"></a>        <span class="kw">return</span> MessagingService.<span class="fu">getInstance</span>();</span>
<span id="cb8-22"><a href="#cb8-22"></a>    }</span>
<span id="cb8-23"><a href="#cb8-23"></a></span>
<span id="cb8-24"><a href="#cb8-24"></a>    <span class="at">@Override</span></span>
<span id="cb8-25"><a href="#cb8-25"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onJoined</span>(<span class="bu">String</span> moniker) {</span>
<span id="cb8-26"><a href="#cb8-26"></a>        <span class="co">// DO nothing for now  </span></span>
<span id="cb8-27"><a href="#cb8-27"></a>    }</span>
<span id="cb8-28"><a href="#cb8-28"></a></span>
<span id="cb8-29"><a href="#cb8-29"></a>    <span class="at">@Override</span></span>
<span id="cb8-30"><a href="#cb8-30"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onStartedNew</span>(<span class="bu">String</span> moniker) {</span>
<span id="cb8-31"><a href="#cb8-31"></a>        Intent intent = <span class="kw">new</span> <span class="fu">Intent</span>(<span class="kw">this</span>, ChatActivity.<span class="fu">class</span>);</span>
<span id="cb8-32"><a href="#cb8-32"></a>        intent.<span class="fu">putExtra</span>(<span class="st">&quot;MONIKER&quot;</span>, moniker);</span>
<span id="cb8-33"><a href="#cb8-33"></a>        <span class="fu">startActivity</span>(intent);</span>
<span id="cb8-34"><a href="#cb8-34"></a>    }</span>
<span id="cb8-35"><a href="#cb8-35"></a>    </span>
<span id="cb8-36"><a href="#cb8-36"></a>}</span></code></pre></div>
<p>We have removed our key generation in the onCreate method. Instead <code>MainActivity</code> now extends <code>BaseConfigActivity</code>. The <code>BaseConfigActivity</code> provides screens to create <strong>New</strong> and to <strong>Join</strong> networks. We just need to define the callback event handlers for each case. The further processing is identical in both cases - both result in your babble node being started and in a babble network – the only difference is the number of nodes.</p>
<p>If you want more control over the network joining screens, the branches with 0.2.1 suffices in the github repo have a worked version using activities external to the <code>babble-android</code> library.</p>
<p>Add the line below as the first line of the class, we will use this later to identified log messages from our app. :</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">public</span> <span class="kw">class</span> MainActivity <span class="kw">extends</span> AppCompatActivity {</span>
<span id="cb9-2"><a href="#cb9-2"></a></span>
<span id="cb9-3"><a href="#cb9-3"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">String</span> TAG = <span class="st">&quot;FIRST-BABBLE-APP&quot;</span>;</span></code></pre></div>
<hr />
<div style="page-break-after: always; visibility: hidden">

</div>
<h3 id="appstate.java">AppState.java</h3>
<p>Copy the source below into place in the same folder as <code>MainActivity.java</code>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw">package</span><span class="im"> io.mosaicnetworks.myfirstapp;</span></span>
<span id="cb10-2"><a href="#cb10-2"></a></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="kw">import</span><span class="im"> com.google.gson.JsonSyntaxException;</span></span>
<span id="cb10-4"><a href="#cb10-4"></a></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="kw">import</span><span class="im"> java.nio.charset.StandardCharsets;</span></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="kw">import</span><span class="im"> java.util.ArrayList;</span></span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="kw">import</span><span class="im"> java.util.HashMap;</span></span>
<span id="cb10-8"><a href="#cb10-8"></a><span class="kw">import</span><span class="im"> java.util.List;</span></span>
<span id="cb10-9"><a href="#cb10-9"></a><span class="kw">import</span><span class="im"> java.util.Map;</span></span>
<span id="cb10-10"><a href="#cb10-10"></a></span>
<span id="cb10-11"><a href="#cb10-11"></a><span class="kw">import</span><span class="im"> io.mosaicnetworks.babble.node.BabbleState;</span></span>
<span id="cb10-12"><a href="#cb10-12"></a></span>
<span id="cb10-13"><a href="#cb10-13"></a><span class="kw">public</span> <span class="kw">class</span> AppState <span class="kw">implements</span> BabbleState {</span>
<span id="cb10-14"><a href="#cb10-14"></a></span>
<span id="cb10-15"><a href="#cb10-15"></a>    <span class="kw">private</span> <span class="dt">byte</span>[] mStateHash = <span class="kw">new</span> <span class="dt">byte</span>[<span class="dv">0</span>];</span>
<span id="cb10-16"><a href="#cb10-16"></a>    <span class="kw">private</span> <span class="dt">final</span> <span class="bu">Map</span>&lt;<span class="bu">Integer</span>, BabbleTx&gt; mState = <span class="kw">new</span> <span class="bu">HashMap</span>&lt;&gt;();</span>
<span id="cb10-17"><a href="#cb10-17"></a>    <span class="kw">private</span> <span class="bu">Integer</span> mNextIndex = <span class="dv">0</span>;</span>
<span id="cb10-18"><a href="#cb10-18"></a></span>
<span id="cb10-19"><a href="#cb10-19"></a>    <span class="at">@Override</span></span>
<span id="cb10-20"><a href="#cb10-20"></a>    <span class="kw">public</span> <span class="dt">byte</span>[] <span class="fu">applyTransactions</span>(<span class="dt">byte</span>[][] transactions) {</span>
<span id="cb10-21"><a href="#cb10-21"></a>        <span class="kw">for</span> (<span class="dt">byte</span>[] rawTx:transactions) {</span>
<span id="cb10-22"><a href="#cb10-22"></a>            <span class="bu">String</span> tx = <span class="kw">new</span> <span class="bu">String</span>(rawTx, StandardCharsets.<span class="fu">UTF_8</span>);</span>
<span id="cb10-23"><a href="#cb10-23"></a></span>
<span id="cb10-24"><a href="#cb10-24"></a>            BabbleTx babbleTx;</span>
<span id="cb10-25"><a href="#cb10-25"></a>            <span class="kw">try</span> {</span>
<span id="cb10-26"><a href="#cb10-26"></a>                babbleTx = BabbleTx.<span class="fu">fromJson</span>(tx);</span>
<span id="cb10-27"><a href="#cb10-27"></a>            } <span class="kw">catch</span> (JsonSyntaxException ex) {</span>
<span id="cb10-28"><a href="#cb10-28"></a>                <span class="co">//skip any malformed transactions</span></span>
<span id="cb10-29"><a href="#cb10-29"></a>                <span class="kw">continue</span>;</span>
<span id="cb10-30"><a href="#cb10-30"></a>            }</span>
<span id="cb10-31"><a href="#cb10-31"></a></span>
<span id="cb10-32"><a href="#cb10-32"></a>            mState.<span class="fu">put</span>(mNextIndex, babbleTx);</span>
<span id="cb10-33"><a href="#cb10-33"></a>            mNextIndex++;</span>
<span id="cb10-34"><a href="#cb10-34"></a>        }</span>
<span id="cb10-35"><a href="#cb10-35"></a></span>
<span id="cb10-36"><a href="#cb10-36"></a>        <span class="fu">updateStateHash</span>();</span>
<span id="cb10-37"><a href="#cb10-37"></a>        <span class="kw">return</span> mStateHash;</span>
<span id="cb10-38"><a href="#cb10-38"></a>    }</span>
<span id="cb10-39"><a href="#cb10-39"></a></span>
<span id="cb10-40"><a href="#cb10-40"></a>    <span class="at">@Override</span></span>
<span id="cb10-41"><a href="#cb10-41"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">reset</span>() {</span>
<span id="cb10-42"><a href="#cb10-42"></a>        mState.<span class="fu">clear</span>();</span>
<span id="cb10-43"><a href="#cb10-43"></a>        mNextIndex = <span class="dv">0</span>;</span>
<span id="cb10-44"><a href="#cb10-44"></a>    }</span>
<span id="cb10-45"><a href="#cb10-45"></a></span>
<span id="cb10-46"><a href="#cb10-46"></a>    <span class="kw">public</span> <span class="bu">List</span>&lt;Message&gt; <span class="fu">getMessagesFromIndex</span>(<span class="bu">Integer</span> index) {</span>
<span id="cb10-47"><a href="#cb10-47"></a></span>
<span id="cb10-48"><a href="#cb10-48"></a>        <span class="kw">if</span> (index&lt;<span class="dv">0</span>) {</span>
<span id="cb10-49"><a href="#cb10-49"></a>            <span class="kw">throw</span> <span class="kw">new</span> <span class="bu">IllegalArgumentException</span>(<span class="st">&quot;Index cannot be less than 0&quot;</span>);</span>
<span id="cb10-50"><a href="#cb10-50"></a>        }</span>
<span id="cb10-51"><a href="#cb10-51"></a></span>
<span id="cb10-52"><a href="#cb10-52"></a>        <span class="kw">if</span> (index &gt;= mNextIndex) {</span>
<span id="cb10-53"><a href="#cb10-53"></a>            <span class="kw">return</span> <span class="kw">new</span> <span class="bu">ArrayList</span>&lt;&gt;();</span>
<span id="cb10-54"><a href="#cb10-54"></a>        }</span>
<span id="cb10-55"><a href="#cb10-55"></a></span>
<span id="cb10-56"><a href="#cb10-56"></a>        <span class="bu">Integer</span> numMessages = mNextIndex - index;</span>
<span id="cb10-57"><a href="#cb10-57"></a></span>
<span id="cb10-58"><a href="#cb10-58"></a>        <span class="bu">List</span>&lt;Message&gt; messages = <span class="kw">new</span> <span class="bu">ArrayList</span>&lt;&gt;(numMessages);</span>
<span id="cb10-59"><a href="#cb10-59"></a></span>
<span id="cb10-60"><a href="#cb10-60"></a>        <span class="kw">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; numMessages; i++) {</span>
<span id="cb10-61"><a href="#cb10-61"></a>            messages.<span class="fu">add</span>(Message.<span class="fu">fromBabbleTx</span>(mState.<span class="fu">get</span>(index + i)));</span>
<span id="cb10-62"><a href="#cb10-62"></a>        }</span>
<span id="cb10-63"><a href="#cb10-63"></a></span>
<span id="cb10-64"><a href="#cb10-64"></a>        <span class="kw">return</span> messages;</span>
<span id="cb10-65"><a href="#cb10-65"></a>    }</span>
<span id="cb10-66"><a href="#cb10-66"></a></span>
<span id="cb10-67"><a href="#cb10-67"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">updateStateHash</span>() {</span>
<span id="cb10-68"><a href="#cb10-68"></a>        <span class="co">//</span><span class="al">TODO</span><span class="co">: implement this</span></span>
<span id="cb10-69"><a href="#cb10-69"></a>    }</span>
<span id="cb10-70"><a href="#cb10-70"></a>}</span></code></pre></div>
<h3 id="babbletx.java">BabbleTx.java</h3>
<p>Copy the source below into place in the same folder as <code>MainActivity.java</code>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb11-1"><a href="#cb11-1"></a><span class="kw">package</span><span class="im"> io.mosaicnetworks.myfirstapp;</span></span>
<span id="cb11-2"><a href="#cb11-2"></a></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="kw">import</span><span class="im"> com.google.gson.Gson;</span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="kw">import</span><span class="im"> com.google.gson.annotations.SerializedName;</span></span>
<span id="cb11-5"><a href="#cb11-5"></a></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="kw">public</span> <span class="kw">class</span> BabbleTx <span class="kw">implements</span> io.<span class="fu">mosaicnetworks</span>.<span class="fu">babble</span>.<span class="fu">node</span>.<span class="fu">BabbleTx</span> {</span>
<span id="cb11-7"><a href="#cb11-7"></a></span>
<span id="cb11-8"><a href="#cb11-8"></a>    <span class="kw">private</span> <span class="dt">final</span> <span class="dt">static</span> Gson gson = <span class="kw">new</span> <span class="fu">Gson</span>();</span>
<span id="cb11-9"><a href="#cb11-9"></a></span>
<span id="cb11-10"><a href="#cb11-10"></a>    <span class="at">@SerializedName</span>(<span class="st">&quot;from&quot;</span>)</span>
<span id="cb11-11"><a href="#cb11-11"></a>    <span class="kw">public</span> <span class="dt">final</span> <span class="bu">String</span> from;</span>
<span id="cb11-12"><a href="#cb11-12"></a></span>
<span id="cb11-13"><a href="#cb11-13"></a>    <span class="at">@SerializedName</span>(<span class="st">&quot;text&quot;</span>)</span>
<span id="cb11-14"><a href="#cb11-14"></a>    <span class="kw">public</span> <span class="dt">final</span> <span class="bu">String</span> text;</span>
<span id="cb11-15"><a href="#cb11-15"></a></span>
<span id="cb11-16"><a href="#cb11-16"></a>    <span class="kw">public</span> <span class="fu">BabbleTx</span>(<span class="bu">String</span> from, <span class="bu">String</span> text) {</span>
<span id="cb11-17"><a href="#cb11-17"></a>        <span class="kw">this</span>.<span class="fu">from</span> = from;</span>
<span id="cb11-18"><a href="#cb11-18"></a>        <span class="kw">this</span>.<span class="fu">text</span> = text;</span>
<span id="cb11-19"><a href="#cb11-19"></a>    }</span>
<span id="cb11-20"><a href="#cb11-20"></a></span>
<span id="cb11-21"><a href="#cb11-21"></a>    <span class="kw">public</span> <span class="dt">static</span> BabbleTx <span class="fu">fromJson</span>(<span class="bu">String</span> txJson) {</span>
<span id="cb11-22"><a href="#cb11-22"></a>        <span class="kw">return</span> gson.<span class="fu">fromJson</span>(txJson, BabbleTx.<span class="fu">class</span>);</span>
<span id="cb11-23"><a href="#cb11-23"></a>    }</span>
<span id="cb11-24"><a href="#cb11-24"></a></span>
<span id="cb11-25"><a href="#cb11-25"></a>    <span class="at">@Override</span></span>
<span id="cb11-26"><a href="#cb11-26"></a>    <span class="kw">public</span> <span class="dt">byte</span>[] <span class="fu">toBytes</span>() {</span>
<span id="cb11-27"><a href="#cb11-27"></a>        <span class="kw">return</span> gson.<span class="fu">toJson</span>(<span class="kw">this</span>).<span class="fu">getBytes</span>();</span>
<span id="cb11-28"><a href="#cb11-28"></a>    }</span>
<span id="cb11-29"><a href="#cb11-29"></a>}</span></code></pre></div>
<h3 id="message.java">Message.java</h3>
<p>Copy the source below into place in the same folder as <code>MainActivity.java</code>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb12-1"><a href="#cb12-1"></a><span class="kw">package</span><span class="im"> io.mosaicnetworks.myfirstapp;</span></span>
<span id="cb12-2"><a href="#cb12-2"></a></span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="kw">import</span><span class="im"> com.stfalcon.chatkit.commons.models.IMessage;</span></span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="kw">import</span><span class="im"> com.stfalcon.chatkit.commons.models.IUser;</span></span>
<span id="cb12-5"><a href="#cb12-5"></a></span>
<span id="cb12-6"><a href="#cb12-6"></a><span class="kw">import</span><span class="im"> java.util.Date;</span></span>
<span id="cb12-7"><a href="#cb12-7"></a></span>
<span id="cb12-8"><a href="#cb12-8"></a><span class="kw">public</span> <span class="dt">final</span> <span class="kw">class</span> Message <span class="kw">implements</span> IMessage {</span>
<span id="cb12-9"><a href="#cb12-9"></a></span>
<span id="cb12-10"><a href="#cb12-10"></a>    <span class="kw">public</span> <span class="dt">final</span> <span class="dt">static</span> <span class="kw">class</span> Author <span class="kw">implements</span> IUser {</span>
<span id="cb12-11"><a href="#cb12-11"></a></span>
<span id="cb12-12"><a href="#cb12-12"></a>        <span class="kw">private</span> <span class="dt">final</span> <span class="bu">String</span> mName;</span>
<span id="cb12-13"><a href="#cb12-13"></a></span>
<span id="cb12-14"><a href="#cb12-14"></a>        <span class="kw">public</span> <span class="fu">Author</span>(<span class="bu">String</span> name) {</span>
<span id="cb12-15"><a href="#cb12-15"></a>            mName = name;</span>
<span id="cb12-16"><a href="#cb12-16"></a>        }</span>
<span id="cb12-17"><a href="#cb12-17"></a></span>
<span id="cb12-18"><a href="#cb12-18"></a>        <span class="at">@Override</span></span>
<span id="cb12-19"><a href="#cb12-19"></a>        <span class="kw">public</span> <span class="bu">String</span> <span class="fu">getId</span>() {</span>
<span id="cb12-20"><a href="#cb12-20"></a>            <span class="kw">return</span> mName;</span>
<span id="cb12-21"><a href="#cb12-21"></a>        }</span>
<span id="cb12-22"><a href="#cb12-22"></a></span>
<span id="cb12-23"><a href="#cb12-23"></a>        <span class="at">@Override</span></span>
<span id="cb12-24"><a href="#cb12-24"></a>        <span class="kw">public</span> <span class="bu">String</span> <span class="fu">getName</span>() {</span>
<span id="cb12-25"><a href="#cb12-25"></a>            <span class="kw">return</span> mName;</span>
<span id="cb12-26"><a href="#cb12-26"></a>        }</span>
<span id="cb12-27"><a href="#cb12-27"></a></span>
<span id="cb12-28"><a href="#cb12-28"></a>        <span class="at">@Override</span></span>
<span id="cb12-29"><a href="#cb12-29"></a>        <span class="kw">public</span> <span class="bu">String</span> <span class="fu">getAvatar</span>() {</span>
<span id="cb12-30"><a href="#cb12-30"></a>            <span class="kw">return</span> <span class="kw">null</span>;</span>
<span id="cb12-31"><a href="#cb12-31"></a>        }</span>
<span id="cb12-32"><a href="#cb12-32"></a>    }</span>
<span id="cb12-33"><a href="#cb12-33"></a></span>
<span id="cb12-34"><a href="#cb12-34"></a>    <span class="kw">private</span> <span class="dt">final</span> <span class="bu">String</span> mText;</span>
<span id="cb12-35"><a href="#cb12-35"></a>    <span class="kw">private</span> <span class="dt">final</span> <span class="bu">String</span> mAuthor;</span>
<span id="cb12-36"><a href="#cb12-36"></a>    <span class="kw">private</span> <span class="dt">final</span> <span class="bu">Date</span> mDate;</span>
<span id="cb12-37"><a href="#cb12-37"></a></span>
<span id="cb12-38"><a href="#cb12-38"></a>    <span class="kw">public</span> <span class="fu">Message</span>(<span class="bu">String</span> text, <span class="bu">String</span> author) {</span>
<span id="cb12-39"><a href="#cb12-39"></a>        mText = text;</span>
<span id="cb12-40"><a href="#cb12-40"></a>        mAuthor = author;</span>
<span id="cb12-41"><a href="#cb12-41"></a>        mDate = <span class="kw">new</span> <span class="bu">Date</span>();</span>
<span id="cb12-42"><a href="#cb12-42"></a>    }</span>
<span id="cb12-43"><a href="#cb12-43"></a></span>
<span id="cb12-44"><a href="#cb12-44"></a>    <span class="kw">public</span> <span class="dt">static</span> Message <span class="fu">fromBabbleTx</span>(BabbleTx babbleTx) {</span>
<span id="cb12-45"><a href="#cb12-45"></a>        <span class="kw">return</span> <span class="kw">new</span> <span class="fu">Message</span>(babbleTx.<span class="fu">text</span>, babbleTx.<span class="fu">from</span>);</span>
<span id="cb12-46"><a href="#cb12-46"></a>    }</span>
<span id="cb12-47"><a href="#cb12-47"></a></span>
<span id="cb12-48"><a href="#cb12-48"></a>    <span class="kw">public</span> BabbleTx <span class="fu">toBabbleTx</span>() {</span>
<span id="cb12-49"><a href="#cb12-49"></a>        <span class="kw">return</span> <span class="kw">new</span> <span class="fu">BabbleTx</span>(mAuthor, mText);</span>
<span id="cb12-50"><a href="#cb12-50"></a>    }</span>
<span id="cb12-51"><a href="#cb12-51"></a></span>
<span id="cb12-52"><a href="#cb12-52"></a>    <span class="at">@Override</span></span>
<span id="cb12-53"><a href="#cb12-53"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">getId</span>() {</span>
<span id="cb12-54"><a href="#cb12-54"></a>        <span class="kw">return</span> mAuthor;</span>
<span id="cb12-55"><a href="#cb12-55"></a>    }</span>
<span id="cb12-56"><a href="#cb12-56"></a></span>
<span id="cb12-57"><a href="#cb12-57"></a>    <span class="at">@Override</span></span>
<span id="cb12-58"><a href="#cb12-58"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">getText</span>() {</span>
<span id="cb12-59"><a href="#cb12-59"></a>        <span class="kw">return</span> mText;</span>
<span id="cb12-60"><a href="#cb12-60"></a>    }</span>
<span id="cb12-61"><a href="#cb12-61"></a></span>
<span id="cb12-62"><a href="#cb12-62"></a>    <span class="at">@Override</span></span>
<span id="cb12-63"><a href="#cb12-63"></a>    <span class="kw">public</span> Author <span class="fu">getUser</span>() {</span>
<span id="cb12-64"><a href="#cb12-64"></a>        <span class="kw">return</span> <span class="kw">new</span> <span class="fu">Author</span>(mAuthor);</span>
<span id="cb12-65"><a href="#cb12-65"></a>    }</span>
<span id="cb12-66"><a href="#cb12-66"></a></span>
<span id="cb12-67"><a href="#cb12-67"></a>    <span class="at">@Override</span></span>
<span id="cb12-68"><a href="#cb12-68"></a>    <span class="kw">public</span> <span class="bu">Date</span> <span class="fu">getCreatedAt</span>() {</span>
<span id="cb12-69"><a href="#cb12-69"></a>        <span class="kw">return</span> mDate;</span>
<span id="cb12-70"><a href="#cb12-70"></a>    }</span>
<span id="cb12-71"><a href="#cb12-71"></a></span>
<span id="cb12-72"><a href="#cb12-72"></a>}</span></code></pre></div>
<p>You will note the section below introduces an external dependency:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb13-1"><a href="#cb13-1"></a><span class="kw">import</span><span class="im"> com.stfalcon.chatkit.commons.models.IMessage;</span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="kw">import</span><span class="im"> com.stfalcon.chatkit.commons.models.IUser;</span></span></code></pre></div>
<p>Add the lines below to the app <code>build.gradle</code> file dependencies section, and click Sync Now on the pop up bar:</p>
<pre><code>    implementation &#39;com.google.code.gson:gson:2.8.5&#39;
    implementation &#39;com.github.stfalcon:chatkit:0.3.3&#39;</code></pre>
<h3 id="messagingservice.java">MessagingService.java</h3>
<p>Copy the source below into place in the same folder as <code>MainActivity.java</code>:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb15-1"><a href="#cb15-1"></a><span class="kw">package</span><span class="im"> io.mosaicnetworks.myfirstapp;</span></span>
<span id="cb15-2"><a href="#cb15-2"></a></span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="kw">import</span><span class="im"> io.mosaicnetworks.babble.node.BabbleService;</span></span>
<span id="cb15-4"><a href="#cb15-4"></a></span>
<span id="cb15-5"><a href="#cb15-5"></a><span class="kw">public</span> <span class="dt">final</span> <span class="kw">class</span> MessagingService <span class="kw">extends</span> BabbleService&lt;AppState&gt; {</span>
<span id="cb15-6"><a href="#cb15-6"></a></span>
<span id="cb15-7"><a href="#cb15-7"></a>    <span class="kw">private</span> <span class="dt">static</span> MessagingService INSTANCE;</span>
<span id="cb15-8"><a href="#cb15-8"></a></span>
<span id="cb15-9"><a href="#cb15-9"></a>    <span class="kw">public</span> <span class="dt">static</span> MessagingService <span class="fu">getInstance</span>() {</span>
<span id="cb15-10"><a href="#cb15-10"></a>        <span class="kw">if</span> (INSTANCE==<span class="kw">null</span>) {</span>
<span id="cb15-11"><a href="#cb15-11"></a>            INSTANCE = <span class="kw">new</span> <span class="fu">MessagingService</span>();</span>
<span id="cb15-12"><a href="#cb15-12"></a>        }</span>
<span id="cb15-13"><a href="#cb15-13"></a></span>
<span id="cb15-14"><a href="#cb15-14"></a>        <span class="kw">return</span> INSTANCE;</span>
<span id="cb15-15"><a href="#cb15-15"></a>    }</span>
<span id="cb15-16"><a href="#cb15-16"></a></span>
<span id="cb15-17"><a href="#cb15-17"></a>    <span class="kw">private</span> <span class="fu">MessagingService</span>() {</span>
<span id="cb15-18"><a href="#cb15-18"></a>        <span class="kw">super</span>(<span class="kw">new</span> <span class="fu">AppState</span>());</span>
<span id="cb15-19"><a href="#cb15-19"></a>    }</span>
<span id="cb15-20"><a href="#cb15-20"></a>}</span></code></pre></div>
<h3 id="chat-activity">Chat Activity</h3>
<p>Create a new empty activity, <code>ChatActivity</code>. We will not add any functionality to it at this point, we just need it to exist as it is referenced in <code>MainActivity</code>.</p>
<h3 id="running-babble">Running Babble</h3>
<p>And finally after all of that cut and paste, we have a working instance of babble — albeit with at least one major drawback — it has no UI and no way to access it.</p>
<p>If you start the app through Android Studio, and look at the logcat output (filtered to just our app), after pressing the New button, entering a Moniker and pressing the Join button, you should see something like below:</p>
<p><img src="./screenshots/logcat_babble.png" title="First Babble LogCat" /></p>
<p>The lines of red text are the lines of interest, stripping out the date and other prefixes gives something like:</p>
<pre><code>msg=&quot;Creating InmemStore&quot; prefix=babble
msg=PARTICIPANTS genesis_peers=1 id=2193277640 moniker=Jon peers=1 prefix=babble
msg=&quot;Start Listening&quot; prefix=babble
msg=&quot;Node belongs to PeerSet&quot; prefix=babble
msg=&quot;FastSync not enabled =&gt; Babbling&quot; prefix=babble
msg=SetHeadAndSeq core.Head= core.Seq=-1 prefix=babble
msg=runasync gossip=true prefix=babble
msg=&quot;Run loop&quot; prefix=babble state=Babbling
msg=BABBLING prefix=babble</code></pre>
<p>The key item is the “<strong>state=Babbling</strong>” line, which denotes that Babble is up and running.</p>
<h2 id="some-explanations">Some Explanations</h2>
<p>We have just added a lot of code, which is all co-dependent. Now we have a babble invocation in place, we can pause to explain what just happened there.</p>
<p>The configuration of a babble node is handled by the <code>BaseConfigActivity</code> class from whom <code>MainActivity</code> inherits. We just need to wire in the <code>ChatActivity</code> to take over once we have a Babble network.</p>
<p>We define a MessagingService using the <code>getBabbleService()</code> function. This boilerplate class wraps BabbleService from the babble-android library.</p>
<p>This project at this stage is available from github from <a href="https://github.com/mosaicnetworks/babble-android-tutorial/tree/stage2">here</a> <a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a></p>
<hr />
<h2 id="interacting-with-babble">Interacting with Babble</h2>
<p>The next stage is to make Babble usable. To do that we need to work on the <code>ChatActivity</code> so it sends and receives messages from Babble.</p>
<p>First up we need a UI. We are going to use <a href="https://github.com/stfalcon-studio/ChatKit">ChatKit</a> rather than reinvent the wheel.</p>
<h3 id="activity_chat.xml">activity_chat.xml</h3>
<p>We can then add the layout to <code>res/layout/activity_chat.xml</code> — replace all the contents with the code below:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb17-1"><a href="#cb17-1"></a><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;utf-8&quot;<span class="kw">?&gt;</span></span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="kw">&lt;RelativeLayout</span></span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="ot">    xmlns:android=</span><span class="st">&quot;http://schemas.android.com/apk/res/android&quot;</span></span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="ot">    xmlns:app=</span><span class="st">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span>
<span id="cb17-5"><a href="#cb17-5"></a><span class="ot">    xmlns:tools=</span><span class="st">&quot;http://schemas.android.com/tools&quot;</span></span>
<span id="cb17-6"><a href="#cb17-6"></a><span class="ot">    android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb17-7"><a href="#cb17-7"></a><span class="ot">    android:layout_height=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb17-8"><a href="#cb17-8"></a><span class="ot">    android:background=</span><span class="st">&quot;@color/white&quot;</span></span>
<span id="cb17-9"><a href="#cb17-9"></a><span class="ot">    tools:context=</span><span class="st">&quot;.ChatActivity&quot;</span><span class="kw">&gt;</span></span>
<span id="cb17-10"><a href="#cb17-10"></a></span>
<span id="cb17-11"><a href="#cb17-11"></a>    <span class="kw">&lt;com.stfalcon.chatkit.messages.MessagesList</span></span>
<span id="cb17-12"><a href="#cb17-12"></a><span class="ot">        android:id=</span><span class="st">&quot;@+id/messagesList&quot;</span></span>
<span id="cb17-13"><a href="#cb17-13"></a><span class="ot">        android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb17-14"><a href="#cb17-14"></a><span class="ot">        android:layout_height=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb17-15"><a href="#cb17-15"></a><span class="ot">        android:layout_above=</span><span class="st">&quot;@+id/input&quot;</span><span class="kw">/&gt;</span></span>
<span id="cb17-16"><a href="#cb17-16"></a></span>
<span id="cb17-17"><a href="#cb17-17"></a>    <span class="kw">&lt;View</span></span>
<span id="cb17-18"><a href="#cb17-18"></a><span class="ot">        android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb17-19"><a href="#cb17-19"></a><span class="ot">        android:layout_height=</span><span class="st">&quot;1dp&quot;</span></span>
<span id="cb17-20"><a href="#cb17-20"></a><span class="ot">        android:layout_above=</span><span class="st">&quot;@+id/input&quot;</span></span>
<span id="cb17-21"><a href="#cb17-21"></a><span class="ot">        android:layout_marginLeft=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb17-22"><a href="#cb17-22"></a><span class="ot">        android:layout_marginRight=</span><span class="st">&quot;16dp&quot;</span></span>
<span id="cb17-23"><a href="#cb17-23"></a><span class="ot">        android:background=</span><span class="st">&quot;@color/gray_light&quot;</span><span class="kw">/&gt;</span></span>
<span id="cb17-24"><a href="#cb17-24"></a></span>
<span id="cb17-25"><a href="#cb17-25"></a>    <span class="kw">&lt;com.stfalcon.chatkit.messages.MessageInput</span></span>
<span id="cb17-26"><a href="#cb17-26"></a><span class="ot">        android:id=</span><span class="st">&quot;@+id/input&quot;</span></span>
<span id="cb17-27"><a href="#cb17-27"></a><span class="ot">        android:layout_width=</span><span class="st">&quot;match_parent&quot;</span></span>
<span id="cb17-28"><a href="#cb17-28"></a><span class="ot">        android:layout_height=</span><span class="st">&quot;wrap_content&quot;</span></span>
<span id="cb17-29"><a href="#cb17-29"></a><span class="ot">        android:layout_alignParentBottom=</span><span class="st">&quot;true&quot;</span></span>
<span id="cb17-30"><a href="#cb17-30"></a><span class="ot">        app:inputHint=</span><span class="st">&quot;@string/hint_enter_a_message&quot;</span></span>
<span id="cb17-31"><a href="#cb17-31"></a><span class="ot">        app:showAttachmentButton=</span><span class="st">&quot;true&quot;</span><span class="kw">/&gt;</span></span>
<span id="cb17-32"><a href="#cb17-32"></a></span>
<span id="cb17-33"><a href="#cb17-33"></a><span class="kw">&lt;/RelativeLayout&gt;</span></span></code></pre></div>
<p>The layout here is a fairly standard chat layout a message entry section at the bottom of the screen and a message display above it.</p>
<h3 id="colors.xml">colors.xml</h3>
<p>We need to the add the following to <code>res/values/colors.xml</code> as it is used in the code changes above.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb18-1"><a href="#cb18-1"></a>    <span class="kw">&lt;color</span><span class="ot"> name=</span><span class="st">&quot;gray_light&quot;</span><span class="kw">&gt;</span>#e8e8e8<span class="kw">&lt;/color&gt;</span>    </span></code></pre></div>
<h3 id="chatactivity.java">ChatActivity.java</h3>
<p>Replace all of the file <code>ChatActivity.java</code> with the code below:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb19-1"><a href="#cb19-1"></a><span class="kw">package</span><span class="im"> io.mosaicnetworks.myfirstapp;</span></span>
<span id="cb19-2"><a href="#cb19-2"></a></span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="kw">import</span><span class="im"> android.content.Intent;</span></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="kw">import</span><span class="im"> android.os.Bundle;</span></span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="kw">import</span><span class="im"> android.widget.Toast;</span></span>
<span id="cb19-6"><a href="#cb19-6"></a></span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="kw">import</span><span class="im"> androidx.appcompat.app.AppCompatActivity;</span></span>
<span id="cb19-8"><a href="#cb19-8"></a></span>
<span id="cb19-9"><a href="#cb19-9"></a><span class="kw">import</span><span class="im"> com.stfalcon.chatkit.messages.MessageInput;</span></span>
<span id="cb19-10"><a href="#cb19-10"></a><span class="kw">import</span><span class="im"> com.stfalcon.chatkit.messages.MessagesList;</span></span>
<span id="cb19-11"><a href="#cb19-11"></a><span class="kw">import</span><span class="im"> com.stfalcon.chatkit.messages.MessagesListAdapter;</span></span>
<span id="cb19-12"><a href="#cb19-12"></a></span>
<span id="cb19-13"><a href="#cb19-13"></a><span class="kw">import</span><span class="im"> java.util.List;</span></span>
<span id="cb19-14"><a href="#cb19-14"></a></span>
<span id="cb19-15"><a href="#cb19-15"></a><span class="kw">import</span><span class="im"> io.mosaicnetworks.babble.node.BabbleService;</span></span>
<span id="cb19-16"><a href="#cb19-16"></a><span class="kw">import</span><span class="im"> io.mosaicnetworks.babble.node.ServiceObserver;</span></span>
<span id="cb19-17"><a href="#cb19-17"></a></span>
<span id="cb19-18"><a href="#cb19-18"></a><span class="kw">public</span> <span class="kw">class</span> ChatActivity <span class="kw">extends</span> AppCompatActivity <span class="kw">implements</span> ServiceObserver {</span>
<span id="cb19-19"><a href="#cb19-19"></a></span>
<span id="cb19-20"><a href="#cb19-20"></a>    <span class="kw">private</span> MessagesListAdapter&lt;Message&gt; mAdapter;</span>
<span id="cb19-21"><a href="#cb19-21"></a>    <span class="kw">private</span> <span class="bu">String</span> mMoniker;</span>
<span id="cb19-22"><a href="#cb19-22"></a>    <span class="kw">private</span> <span class="dt">final</span> MessagingService mMessagingService = </span>
<span id="cb19-23"><a href="#cb19-23"></a>                                            MessagingService.<span class="fu">getInstance</span>();</span>
<span id="cb19-24"><a href="#cb19-24"></a>    <span class="kw">private</span> <span class="bu">Integer</span> mMessageIndex = <span class="dv">0</span>;</span>
<span id="cb19-25"><a href="#cb19-25"></a></span>
<span id="cb19-26"><a href="#cb19-26"></a>    <span class="at">@Override</span></span>
<span id="cb19-27"><a href="#cb19-27"></a>    <span class="kw">protected</span> <span class="dt">void</span> <span class="fu">onCreate</span>(Bundle savedInstanceState) {</span>
<span id="cb19-28"><a href="#cb19-28"></a>        <span class="kw">super</span>.<span class="fu">onCreate</span>(savedInstanceState);</span>
<span id="cb19-29"><a href="#cb19-29"></a>        <span class="fu">setContentView</span>(R.<span class="fu">layout</span>.<span class="fu">activity_chat</span>);</span>
<span id="cb19-30"><a href="#cb19-30"></a></span>
<span id="cb19-31"><a href="#cb19-31"></a>        Intent intent = <span class="fu">getIntent</span>();</span>
<span id="cb19-32"><a href="#cb19-32"></a>        mMoniker = intent.<span class="fu">getStringExtra</span>(<span class="st">&quot;MONIKER&quot;</span>);</span>
<span id="cb19-33"><a href="#cb19-33"></a></span>
<span id="cb19-34"><a href="#cb19-34"></a>        <span class="fu">initialiseAdapter</span>();</span>
<span id="cb19-35"><a href="#cb19-35"></a>        mMessagingService.<span class="fu">registerObserver</span>(<span class="kw">this</span>);</span>
<span id="cb19-36"><a href="#cb19-36"></a></span>
<span id="cb19-37"><a href="#cb19-37"></a>        <span class="kw">if</span> (mMessagingService.<span class="fu">getState</span>()!= </span>
<span id="cb19-38"><a href="#cb19-38"></a>                        BabbleService.<span class="fu">State</span>.<span class="fu">RUNNING_WITH_DISCOVERY</span>) {</span>
<span id="cb19-39"><a href="#cb19-39"></a>            Toast.<span class="fu">makeText</span>(<span class="kw">this</span>, </span>
<span id="cb19-40"><a href="#cb19-40"></a>                        <span class="st">&quot;Unable to advertise peers&quot;</span>, </span>
<span id="cb19-41"><a href="#cb19-41"></a>                        Toast.<span class="fu">LENGTH_LONG</span>).<span class="fu">show</span>();</span>
<span id="cb19-42"><a href="#cb19-42"></a>        }</span>
<span id="cb19-43"><a href="#cb19-43"></a>    }</span>
<span id="cb19-44"><a href="#cb19-44"></a></span>
<span id="cb19-45"><a href="#cb19-45"></a>    <span class="kw">private</span> <span class="dt">void</span> <span class="fu">initialiseAdapter</span>() {</span>
<span id="cb19-46"><a href="#cb19-46"></a>        MessagesList mMessagesList = <span class="fu">findViewById</span>(R.<span class="fu">id</span>.<span class="fu">messagesList</span>);</span>
<span id="cb19-47"><a href="#cb19-47"></a></span>
<span id="cb19-48"><a href="#cb19-48"></a>        mAdapter = <span class="kw">new</span> MessagesListAdapter&lt;&gt;(mMoniker, <span class="kw">null</span>);</span>
<span id="cb19-49"><a href="#cb19-49"></a>        mMessagesList.<span class="fu">setAdapter</span>(mAdapter);</span>
<span id="cb19-50"><a href="#cb19-50"></a></span>
<span id="cb19-51"><a href="#cb19-51"></a>        MessageInput input = <span class="fu">findViewById</span>(R.<span class="fu">id</span>.<span class="fu">input</span>);</span>
<span id="cb19-52"><a href="#cb19-52"></a></span>
<span id="cb19-53"><a href="#cb19-53"></a>        input.<span class="fu">setInputListener</span>(<span class="kw">new</span> MessageInput.<span class="fu">InputListener</span>() {</span>
<span id="cb19-54"><a href="#cb19-54"></a>            <span class="at">@Override</span></span>
<span id="cb19-55"><a href="#cb19-55"></a>            <span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">onSubmit</span>(<span class="bu">CharSequence</span> input) {</span>
<span id="cb19-56"><a href="#cb19-56"></a>                mMessagingService.<span class="fu">submitTx</span>(</span>
<span id="cb19-57"><a href="#cb19-57"></a>                    <span class="kw">new</span> <span class="fu">Message</span>(input.<span class="fu">toString</span>(), mMoniker).<span class="fu">toBabbleTx</span>());</span>
<span id="cb19-58"><a href="#cb19-58"></a>                <span class="kw">return</span> <span class="kw">true</span>;</span>
<span id="cb19-59"><a href="#cb19-59"></a>            }</span>
<span id="cb19-60"><a href="#cb19-60"></a>        });</span>
<span id="cb19-61"><a href="#cb19-61"></a>    }</span>
<span id="cb19-62"><a href="#cb19-62"></a></span>
<span id="cb19-63"><a href="#cb19-63"></a>    <span class="at">@Override</span></span>
<span id="cb19-64"><a href="#cb19-64"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">stateUpdated</span>() {</span>
<span id="cb19-65"><a href="#cb19-65"></a></span>
<span id="cb19-66"><a href="#cb19-66"></a>        <span class="dt">final</span> <span class="bu">List</span>&lt;Message&gt; newMessages = </span>
<span id="cb19-67"><a href="#cb19-67"></a>                mMessagingService.<span class="fu">state</span>.<span class="fu">getMessagesFromIndex</span>(mMessageIndex);</span>
<span id="cb19-68"><a href="#cb19-68"></a></span>
<span id="cb19-69"><a href="#cb19-69"></a>        <span class="fu">runOnUiThread</span>(<span class="kw">new</span> <span class="bu">Runnable</span>() {</span>
<span id="cb19-70"><a href="#cb19-70"></a>            <span class="at">@Override</span></span>
<span id="cb19-71"><a href="#cb19-71"></a>            <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span>() {</span>
<span id="cb19-72"><a href="#cb19-72"></a>                <span class="kw">for</span> (Message message : newMessages ) {</span>
<span id="cb19-73"><a href="#cb19-73"></a>                    mAdapter.<span class="fu">addToStart</span>(message, <span class="kw">true</span>);</span>
<span id="cb19-74"><a href="#cb19-74"></a>                }</span>
<span id="cb19-75"><a href="#cb19-75"></a>            }</span>
<span id="cb19-76"><a href="#cb19-76"></a>        });</span>
<span id="cb19-77"><a href="#cb19-77"></a></span>
<span id="cb19-78"><a href="#cb19-78"></a>        mMessageIndex = mMessageIndex + newMessages.<span class="fu">size</span>();</span>
<span id="cb19-79"><a href="#cb19-79"></a>    }</span>
<span id="cb19-80"><a href="#cb19-80"></a></span>
<span id="cb19-81"><a href="#cb19-81"></a>    <span class="at">@Override</span></span>
<span id="cb19-82"><a href="#cb19-82"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onBackPressed</span>() {</span>
<span id="cb19-83"><a href="#cb19-83"></a>        mMessagingService.<span class="fu">leave</span>(<span class="kw">null</span>);</span>
<span id="cb19-84"><a href="#cb19-84"></a>        <span class="kw">super</span>.<span class="fu">onBackPressed</span>();</span>
<span id="cb19-85"><a href="#cb19-85"></a>    }</span>
<span id="cb19-86"><a href="#cb19-86"></a></span>
<span id="cb19-87"><a href="#cb19-87"></a>    <span class="at">@Override</span></span>
<span id="cb19-88"><a href="#cb19-88"></a>    <span class="kw">protected</span> <span class="dt">void</span> <span class="fu">onDestroy</span>() {</span>
<span id="cb19-89"><a href="#cb19-89"></a>        mMessagingService.<span class="fu">removeObserver</span>(<span class="kw">this</span>);</span>
<span id="cb19-90"><a href="#cb19-90"></a></span>
<span id="cb19-91"><a href="#cb19-91"></a>        <span class="kw">super</span>.<span class="fu">onDestroy</span>();</span>
<span id="cb19-92"><a href="#cb19-92"></a>    }</span>
<span id="cb19-93"><a href="#cb19-93"></a>}</span></code></pre></div>
<h3 id="strings.xml">strings.xml</h3>
<p>We need to the add the following to <code>res/values/strings.xml</code> as they are used in the code changes above.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode xml"><code class="sourceCode xml"><span id="cb20-1"><a href="#cb20-1"></a>    <span class="kw">&lt;string</span><span class="ot"> name=</span><span class="st">&quot;hint_enter_a_message&quot;</span><span class="kw">&gt;</span>Enter a message<span class="kw">&lt;/string&gt;</span></span>
<span id="cb20-2"><a href="#cb20-2"></a>    </span></code></pre></div>
<h3 id="build-run-and-test">Build, Run and Test</h3>
<p>Build your app and run it. You should now be able to start a chat with yourself and send messages to yourself as below:</p>
<p><img src="./screenshots/first_chat.png" title="First Chat" style="width:50.0%" /></p>
<p>This project at this stage is available from github from <a href="https://github.com/mosaicnetworks/babble-android-tutorial/tree/stage3">here</a> <a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a></p>
<hr />
<div style="page-break-after: always; visibility: hidden">

</div>
<h2 id="joining">Joining</h2>
<p>Thus far, we have been dealing with a single node, which kind of misses the whole point of having a blockchain. So this section remedies this. We will add a new button the MainActivity to Join an existing blockchain. This will require discovering the network - we will just enter an IP address for the moment - although more complex schemes would be used in a production environment.</p>
<p>In the previous version (0.2.1) of Babble-Android, the explanation for joining was over 400 lines of markdown text (plus screenshots). As of 0.2.2, it is just to add 3 lines of code (shown in context below) to <code>MainActivity.java</code></p>
<div class="sourceCode" id="cb21"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb21-1"><a href="#cb21-1"></a>    <span class="at">@Override</span></span>
<span id="cb21-2"><a href="#cb21-2"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onJoined</span>(<span class="bu">String</span> moniker) {</span>
<span id="cb21-3"><a href="#cb21-3"></a>        Intent intent = <span class="kw">new</span> <span class="fu">Intent</span>(<span class="kw">this</span>, ChatActivity.<span class="fu">class</span>);</span>
<span id="cb21-4"><a href="#cb21-4"></a>        intent.<span class="fu">putExtra</span>(<span class="st">&quot;MONIKER&quot;</span>, moniker);</span>
<span id="cb21-5"><a href="#cb21-5"></a>        <span class="fu">startActivity</span>(intent);</span>
<span id="cb21-6"><a href="#cb21-6"></a>    }</span></code></pre></div>
<h3 id="build-run-and-test-1">Build, Run and Test</h3>
<p>Build your app and run it on 2 devices. You should now be able to start a chat on one and join with the other:</p>
<p><img src="./screenshots/stage_4.png" title="Stage 4 Phone" style="width:35.0%" /> <img src="./screenshots/stage_4_tab.png" title="Stage 4 Tablet" style="width:60.0%" /></p>
<p>This project at this stage is available from github from <a href="https://github.com/mosaicnetworks/babble-android-tutorial/tree/stage4">here</a> <a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a></p>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>The sample app is part of the <code>babble-android</code> library and is available from the <a href="https://github.com/mosaicnetworks/babble-android">GitHub repo</a><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>You can read more about AndroidX here: <a href="https://android-developers.googleblog.com/2018/05/hello-world-androidx.html">https://android-developers.googleblog.com/2018/05/hello-world-androidx.html</a><a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p>API version 19 is Android 4.4 (KitKat). In May 3.8% of devices were using version 18 or lower. Android 4.4 was released in 2013. Whilst it would be possible to code support for earlier versions, the existing code uses Android features introduced in Android 4.4.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4" role="doc-endnote"><p>This code is the stage1 branch at https://github.com/mosaicnetworks/babble-android-tutorial/tree/stage1<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5" role="doc-endnote"><p><a href="https://developer.android.com/studio/write/image-asset-studio">Android Studio Image Asset Studio</a> is described here: https://developer.android.com/studio/write/image-asset-studio<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6" role="doc-endnote"><p>The sample app is part of the <code>babble-android</code> library and is available from the <a href="https://github.com/mosaicnetworks/babble-android">GitHub repo</a><a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7" role="doc-endnote"><p>This code is the stage2 branch at https://github.com/mosaicnetworks/babble-android-tutorial/tree/stage2<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8" role="doc-endnote"><p>This code is the stage3 branch at https://github.com/mosaicnetworks/babble-android-tutorial/tree/stage3<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9" role="doc-endnote"><p>This code is the stage4 branch at https://github.com/mosaicnetworks/babble-android-tutorial/tree/stage4<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
</body>
</html>
